<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }} - Text to Podcast</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Alpine.js (for interactivity) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-12 text-center">
            <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                üéôÔ∏è {{ app_name }}
            </h1>
            <p class="text-gray-400 text-lg">Transform text or PDFs into professional audiobooks with AI</p>
            <p class="text-gray-500 text-sm mt-2">v{{ app_version }}</p>
        </header>

        <!-- Main Form -->
        <div x-data="podcastForm()" class="space-y-8">

            <!-- Input Mode Selection -->
            <section class="bg-gray-800 rounded-lg p-6 shadow-xl">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">1</span>
                    Input Source
                </h2>

                <!-- Mode Toggle -->
                <div class="flex gap-4 mb-6">
                    <button
                        @click="inputMode = 'text'"
                        :class="inputMode === 'text' ? 'bg-blue-600 border-blue-500' : 'bg-gray-700 border-gray-600'"
                        class="flex-1 py-3 px-6 rounded-lg border-2 transition hover:border-blue-500"
                    >
                        <span class="text-lg">üìù Text Input</span>
                        <p class="text-xs text-gray-400 mt-1">Paste article or blog post</p>
                    </button>
                    <button
                        @click="inputMode = 'pdf'"
                        :class="inputMode === 'pdf' ? 'bg-purple-600 border-purple-500' : 'bg-gray-700 border-gray-600'"
                        class="flex-1 py-3 px-6 rounded-lg border-2 transition hover:border-purple-500"
                    >
                        <span class="text-lg">üìÑ PDF Upload</span>
                        <p class="text-xs text-gray-400 mt-1">Upload book or magazine</p>
                    </button>
                </div>

                <!-- Text Input Mode -->
                <div x-show="inputMode === 'text'" x-transition>
                    <textarea
                        x-model="form.text"
                        rows="12"
                        placeholder="Paste your article, blog post, or any text here... (minimum 100 characters)"
                        class="w-full bg-gray-700 text-gray-100 rounded-lg p-4 border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                    ></textarea>
                    <div class="mt-2 text-sm text-gray-400 flex justify-between">
                        <span x-text="`${form.text.length} characters`"></span>
                        <span x-text="`~${Math.ceil(form.text.split(' ').length / 150)} min read`"></span>
                    </div>
                </div>

                <!-- PDF Upload Mode -->
                <div x-show="inputMode === 'pdf'" x-transition>
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-purple-500 transition">
                        <input
                            type="file"
                            id="pdfFile"
                            accept=".pdf"
                            @change="handleFileSelect($event)"
                            class="hidden"
                        >
                        <label for="pdfFile" class="cursor-pointer">
                            <div class="text-6xl mb-4">üìÑ</div>
                            <p class="text-lg mb-2">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-400">PDF files up to 50MB</p>
                        </label>
                    </div>

                    <!-- Selected File Info -->
                    <div x-show="selectedFile" x-transition class="mt-4 bg-gray-700 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">üìÑ</span>
                            <div>
                                <p class="font-semibold" x-text="selectedFile?.name"></p>
                                <p class="text-sm text-gray-400" x-text="formatBytes(selectedFile?.size)"></p>
                            </div>
                        </div>
                        <button
                            @click="clearFile()"
                            class="text-red-400 hover:text-red-300 transition"
                            title="Remove file"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- PDF Processing Info -->
                    <div class="mt-4 bg-purple-900 bg-opacity-20 border border-purple-500 rounded-lg p-4">
                        <p class="text-sm text-purple-200">
                            <strong>ü§ñ AI-Powered Processing:</strong><br>
                            ‚Ä¢ Automatic language detection<br>
                            ‚Ä¢ Chapter detection (books, magazines, articles)<br>
                            ‚Ä¢ Image descriptions generation<br>
                            ‚Ä¢ URL and citation cleanup<br>
                            ‚Ä¢ OCR support for scanned PDFs
                        </p>
                    </div>
                </div>
            </section>

            <!-- Metadata -->
            <section class="bg-gray-800 rounded-lg p-6 shadow-xl">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <span class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">2</span>
                    Podcast Details
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Title *</label>
                        <input
                            type="text"
                            x-model="form.metadata.title"
                            placeholder="My Amazing Podcast"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Author</label>
                        <input
                            type="text"
                            x-model="form.metadata.author"
                            placeholder="John Doe"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                        >
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea
                            x-model="form.metadata.description"
                            rows="2"
                            placeholder="A brief description of your podcast..."
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                        ></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Language</label>
                        <select
                            x-model="form.metadata.language"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                        >
                            <option value="en">English</option>
                            <option value="fr">Fran√ßais</option>
                            <option value="es">Espa√±ol</option>
                            <option value="de">Deutsch</option>
                            <option value="it">Italiano</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Genre</label>
                        <input
                            type="text"
                            x-model="form.metadata.genre"
                            placeholder="Audiobook, Technology, Education..."
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                        >
                    </div>
                </div>
            </section>

            <!-- Voice & Audio Options -->
            <section class="bg-gray-800 rounded-lg p-6 shadow-xl">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <span class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">3</span>
                    Voice & Audio Settings
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Voice</label>
                        <select
                            x-model="form.tts_options.voice"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                        >
                            <template x-for="(voiceInfo, voiceId) in availableVoices" :key="voiceId">
                                <option :value="voiceId" x-text="`${voiceInfo.name} (${voiceInfo.gender}, ${voiceInfo.accent})`"></option>
                            </template>
                        </select>
                        <p class="text-xs text-gray-400 mt-1" x-text="`${Object.keys(availableVoices).length} voices available`"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Speed</label>
                        <input
                            type="number"
                            x-model.number="form.tts_options.speed"
                            min="0.5"
                            max="2.0"
                            step="0.1"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                        >
                        <span class="text-xs text-gray-400" x-text="`${form.tts_options.speed}x`"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Format</label>
                        <select
                            x-model="form.audio_options.format"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                        >
                            {% for format_id, format_info in audio_formats.items() %}
                            <option value="{{ format_id }}">{{ format_id.upper() }} ({{ format_info.best_for }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Bitrate</label>
                        <select
                            x-model="form.audio_options.bitrate"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                        >
                            <option value="32k">32k (Low)</option>
                            <option value="64k">64k (Good)</option>
                            <option value="128k">128k (High)</option>
                            <option value="192k">192k (Very High)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Chunk Size</label>
                        <input
                            type="number"
                            x-model.number="form.tts_options.chunk_size"
                            min="1000"
                            max="10000"
                            step="500"
                            class="w-full bg-gray-700 text-gray-100 rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"
                        >
                    </div>
                </div>

                <!-- Advanced Options (Collapsible) -->
                <div x-data="{ open: false }" class="mt-4">
                    <button
                        @click="open = !open"
                        class="text-sm text-blue-400 hover:text-blue-300 transition"
                    >
                        <span x-text="open ? '‚ñº Hide Advanced Options' : '‚ñ∂ Show Advanced Options'"></span>
                    </button>
                    <div x-show="open" x-cloak x-transition class="mt-4 space-y-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" x-model="form.tts_options.preserve_sentence" class="rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500">
                            <span class="text-sm">Preserve sentence boundaries</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" x-model="form.tts_options.add_chapter_markers" class="rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500">
                            <span class="text-sm">Add chapter markers</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" x-model="form.tts_options.remove_urls" class="rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500">
                            <span class="text-sm">Remove URLs from text</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" x-model="form.audio_options.embed_cover" class="rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500">
                            <span class="text-sm">Embed cover art</span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Submit Button -->
            <div class="text-center">
                <button
                    @click="submitForm()"
                    :disabled="isProcessing || !canSubmit()"
                    class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-12 py-4 rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                >
                    <span x-show="!isProcessing">
                        <span x-show="inputMode === 'text'">üéôÔ∏è Create Podcast</span>
                        <span x-show="inputMode === 'pdf'">üìö Create Audiobook</span>
                    </span>
                    <span x-show="isProcessing" x-cloak>
                        <svg class="animate-spin inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-show="inputMode === 'text'">Processing...</span>
                        <span x-show="inputMode === 'pdf'">Analyzing PDF with AI...</span>
                    </span>
                </button>
                <p class="text-sm text-gray-400 mt-3" x-show="inputMode === 'text' && form.text.length < 100" x-cloak>
                    Minimum 100 characters required
                </p>
                <p class="text-sm text-gray-400 mt-3" x-show="inputMode === 'pdf' && !selectedFile" x-cloak>
                    Please select a PDF file
                </p>
            </div>

            <!-- Active Jobs -->
            <div x-show="jobs.length > 0" x-cloak class="bg-gray-800 rounded-lg p-6 shadow-xl">
                <h3 class="text-2xl font-semibold mb-4 flex items-center justify-between">
                    <span>üìä Active Jobs</span>
                    <span class="text-sm text-gray-400" x-text="`${jobs.length} job(s)`"></span>
                </h3>

                <div class="space-y-4">
                    <template x-for="job in jobs" :key="job.job_id">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <!-- Job Header -->
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="font-semibold text-lg" x-text="job.title || job.job_id.substring(0, 8)"></h4>
                                    <p class="text-sm text-gray-400">
                                        <span x-text="getStatusBadge(job.status)"></span>
                                        <span x-show="job.position_in_queue" x-text="`‚Ä¢ Position: ${job.position_in_queue}`"></span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span class="text-2xl font-bold" x-show="job.progress" x-text="`${job.progress?.progress_percent || 0}%`"></span>
                                    <p class="text-xs text-gray-400" x-show="job.progress?.estimated_time_remaining" x-text="`ETA: ${formatTime(job.progress?.estimated_time_remaining)}`"></p>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div x-show="job.status === 'started' && job.progress" class="mb-2">
                                <div class="w-full bg-gray-600 rounded-full h-3 overflow-hidden">
                                    <div
                                        class="h-3 rounded-full transition-all duration-500"
                                        :class="getProgressBarClass(job.status)"
                                        :style="`width: ${job.progress?.progress_percent || 0}%`"
                                    ></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1" x-text="job.progress?.step_name || 'Processing...'"></p>
                            </div>

                            <!-- Job completed/failed message -->
                            <div x-show="job.status === 'finished'" class="text-green-400 text-sm">
                                ‚úÖ Completed successfully
                            </div>
                            <div x-show="job.status === 'failed'" class="text-red-400 text-sm">
                                ‚ùå Failed: <span x-text="job.error"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Result -->
            <div x-show="result" x-cloak class="bg-green-900 bg-opacity-30 border border-green-500 rounded-lg p-6 shadow-xl">
                <h3 class="text-2xl font-semibold mb-4 text-green-400">‚úÖ Podcast Created!</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>File:</strong> <span x-text="result?.podcast?.filename"></span></p>
                    <p><strong>Duration:</strong> <span x-text="formatDuration(result?.podcast?.duration_seconds)"></span></p>
                    <p><strong>Size:</strong> <span x-text="formatBytes(result?.podcast?.file_size)"></span></p>
                    <p><strong>Processing Time:</strong> <span x-text="`${result?.processing?.processing_time_seconds?.toFixed(1)}s`"></span></p>
                </div>
                <a
                    :href="`/data/shared/podcasts/final/${result?.podcast?.filename}`"
                    download
                    class="mt-4 inline-block bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition"
                >
                    üì• Download Podcast
                </a>
            </div>

            <!-- Error -->
            <div x-show="error" x-cloak class="bg-red-900 bg-opacity-30 border border-red-500 rounded-lg p-6 shadow-xl">
                <h3 class="text-2xl font-semibold mb-2 text-red-400">‚ùå Error</h3>
                <p x-text="error" class="text-sm"></p>
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p>Powered by <strong>Kokoro TTS</strong> ‚Ä¢ Made with ‚ù§Ô∏è by ServerLab</p>
        </footer>
    </div>

    <script>
        function podcastForm() {
            return {
                inputMode: 'text',  // 'text' or 'pdf'
                selectedFile: null,
                form: {
                    text: '',
                    metadata: {
                        title: '',
                        author: '',
                        description: '',
                        language: 'en',
                        genre: 'Audiobook',
                        narrator: 'Kokoro TTS',
                    },
                    tts_options: {
                        voice: '{{ default_voice }}',
                        speed: {{ default_speed }},
                        chunk_size: 4000,
                        preserve_sentence: true,
                        add_chapter_markers: true,
                        remove_urls: true,
                        remove_markdown: true,
                    },
                    audio_options: {
                        format: 'm4b',
                        bitrate: '{{ default_bitrate }}',
                        sample_rate: 24000,
                        channels: 1,
                        embed_cover: true,
                    },
                    processing_options: {
                        async_mode: false,
                        max_parallel_tts: 5,
                        return_binary: false,
                    }
                },
                allVoices: {},
                availableVoices: {},
                isProcessing: false,
                result: null,
                error: null,
                jobs: [],
                jobPollingInterval: null,

                async init() {
                    // Fetch all voices on component init
                    await this.fetchVoices();

                    // Watch for language changes
                    this.$watch('form.metadata.language', (newLang) => {
                        this.filterVoicesByLanguage(newLang);
                    });

                    // Start job polling
                    await this.fetchJobs();  // Initial fetch
                    this.jobPollingInterval = setInterval(() => {
                        this.fetchJobs();
                    }, 3000);  // Poll every 3 seconds
                },

                destroy() {
                    // Cleanup polling on component destroy
                    if (this.jobPollingInterval) {
                        clearInterval(this.jobPollingInterval);
                    }
                },

                async fetchVoices() {
                    try {
                        const response = await fetch('/api/v1/voices');
                        if (response.ok) {
                            this.allVoices = await response.json();
                            this.filterVoicesByLanguage(this.form.metadata.language);
                        }
                    } catch (err) {
                        console.error('Failed to fetch voices:', err);
                    }
                },

                filterVoicesByLanguage(language) {
                    // Filter voices by selected language
                    this.availableVoices = Object.fromEntries(
                        Object.entries(this.allVoices).filter(([voiceId, voiceInfo]) =>
                            voiceInfo.language === language
                        )
                    );

                    // If current voice is not in filtered list, select first available
                    if (!this.availableVoices[this.form.tts_options.voice]) {
                        const firstVoice = Object.keys(this.availableVoices)[0];
                        if (firstVoice) {
                            this.form.tts_options.voice = firstVoice;
                        }
                    }
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type === 'application/pdf') {
                        this.selectedFile = file;
                        // Auto-fill title from filename if empty
                        if (!this.form.metadata.title) {
                            this.form.metadata.title = file.name.replace('.pdf', '');
                        }
                    } else {
                        alert('Please select a valid PDF file');
                        event.target.value = '';
                    }
                },

                clearFile() {
                    this.selectedFile = null;
                    document.getElementById('pdfFile').value = '';
                },

                canSubmit() {
                    if (this.inputMode === 'text') {
                        return this.form.text.length >= 100;
                    } else if (this.inputMode === 'pdf') {
                        return this.selectedFile !== null;
                    }
                    return false;
                },

                async submitForm() {
                    this.isProcessing = true;
                    this.result = null;
                    this.error = null;

                    try {
                        let response;

                        if (this.inputMode === 'text') {
                            // Text mode: JSON payload
                            response = await fetch('/api/v1/create-podcast', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(this.form)
                            });
                        } else {
                            // PDF mode: FormData (multipart/form-data)
                            const formData = new FormData();
                            formData.append('pdf_file', this.selectedFile);

                            // Append metadata as JSON string
                            formData.append('metadata_json', JSON.stringify(this.form.metadata));
                            formData.append('tts_options_json', JSON.stringify(this.form.tts_options));
                            formData.append('audio_options_json', JSON.stringify(this.form.audio_options));

                            // Enable async mode for PDF (can take longer)
                            const processingOptions = { ...this.form.processing_options, async_mode: true };
                            formData.append('processing_options_json', JSON.stringify(processingOptions));

                            response = await fetch('/api/v1/create-podcast', {
                                method: 'POST',
                                // No Content-Type header - browser sets it with boundary automatically
                                body: formData
                            });
                        }

                        if (!response.ok) {
                            // Try to parse JSON error response
                            let errorMessage = 'Unknown error';
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.detail || errorMessage;
                            } catch (e) {
                                // If JSON parsing fails (HTML error page), show generic message
                                errorMessage = `Server error (${response.status}). Please check service configuration.`;
                            }
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();

                        if (this.inputMode === 'pdf' && data.job_id) {
                            // PDF mode with async processing - show job in queue
                            this.result = null;
                            // Job will appear in "Active Jobs" section via polling
                            await this.fetchJobs();
                        } else {
                            // Sync mode or immediate result
                            this.result = data;

                            // Scroll to result
                            setTimeout(() => {
                                document.querySelector('[x-show="result"]')?.scrollIntoView({ behavior: 'smooth' });
                            }, 100);
                        }

                    } catch (err) {
                        this.error = err.message;
                        console.error('Error creating podcast:', err);
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async fetchJobs() {
                    try {
                        const response = await fetch('/api/v1/jobs');
                        if (response.ok) {
                            const data = await response.json();
                            // Filter to show only active jobs (queued, started, or recently finished/failed)
                            this.jobs = data.jobs.filter(job =>
                                job.status === 'queued' ||
                                job.status === 'started' ||
                                (job.status === 'finished' && this.isRecent(job.ended_at)) ||
                                (job.status === 'failed' && this.isRecent(job.ended_at))
                            );
                        }
                    } catch (err) {
                        console.error('Failed to fetch jobs:', err);
                    }
                },

                isRecent(timestamp) {
                    if (!timestamp) return false;
                    const now = new Date();
                    const jobTime = new Date(timestamp);
                    const diffMinutes = (now - jobTime) / 1000 / 60;
                    return diffMinutes < 5;  // Show finished/failed jobs for 5 minutes
                },

                getStatusBadge(status) {
                    const badges = {
                        'queued': '‚è∏Ô∏è Queued',
                        'started': '‚ñ∂Ô∏è Processing',
                        'finished': '‚úÖ Completed',
                        'failed': '‚ùå Failed',
                        'deferred': '‚è∞ Deferred'
                    };
                    return badges[status] || status;
                },

                getProgressBarClass(status) {
                    return status === 'started'
                        ? 'bg-gradient-to-r from-blue-500 to-purple-600'
                        : 'bg-gray-500';
                },

                formatTime(seconds) {
                    if (!seconds) return '';
                    if (seconds < 60) return `${Math.round(seconds)}s`;
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.round(seconds % 60);
                    return `${mins}m ${secs}s`;
                },

                formatDuration(seconds) {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}m ${secs}s`;
                },

                formatBytes(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
            }
        }
    </script>
</body>
</html>
